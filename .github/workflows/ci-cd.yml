# name: CI/CD Pipeline

# on:
#   push:
#     branches: [ main ]
#     paths-ignore:
#       - 'kubernetes/deployment.yaml'
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: write
#   packages: write

# jobs:
#   test:
#     name: Unit Testing
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - run: npm ci
#       - run: npm test || echo "No tests found"

#   lint:
#     name: Lint
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - run: npm ci
#       - run: npm run lint

#   build:
#     name: Build
#     runs-on: ubuntu-latest
#     needs: [test, lint]
#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/setup-node@v4
#         with:
#           node-version: '20'
#           cache: 'npm'

#       - run: npm ci
#       - run: npm run build

#       - uses: actions/upload-artifact@v4
#         with:
#           name: build-artifacts
#           path: dist/

#   docker:
#     name: Docker Build, Scan & Push
#     runs-on: ubuntu-latest
#     needs: [build]

#     outputs:
#       image_tag: ${{ steps.tag.outputs.tag }}

#     env:
#       REGISTRY: ghcr.io

#     steps:
#       - uses: actions/checkout@v4

#       - uses: actions/download-artifact@v4
#         with:
#           name: build-artifacts
#           path: dist/

#       # ðŸ”’ FORCE LOWERCASE IMAGE NAME (CRITICAL FIX)
#       - name: Normalize image name
#         id: image
#         run: |
#           echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

#       - uses: docker/setup-buildx-action@v3

#       - name: Login to GHCR
#         uses: docker/login-action@v3
#         with:
#           registry: ${{ env.REGISTRY }}
#           username: ${{ github.actor }}
#           password: ${{ secrets.TOKEN }}

#       - name: Docker metadata
#         id: meta
#         uses: docker/metadata-action@v5
#         with:
#           images: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}
#           tags: |
#             type=sha,format=long
#             latest

#       - name: Build image
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           load: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}

#       - name: Trivy vulnerability scan
#         uses: aquasecurity/trivy-action@master
#         with:
#           image-ref: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}:sha-${{ github.sha }}
#           exit-code: '1'
#           severity: 'CRITICAL,HIGH'
#           ignore-unfixed: true

#       - name: Push image
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           push: true
#           tags: ${{ steps.meta.outputs.tags }}
#           labels: ${{ steps.meta.outputs.labels }}

#       - name: Set image tag
#         id: tag
#         run: echo "tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

#   update-k8s:
#     name: Update Kubernetes Manifest (GitOps)
#     runs-on: ubuntu-latest
#     needs: [docker]
#     if: github.ref == 'refs/heads/main' && github.event_name == 'push'

#     steps:
#       - uses: actions/checkout@v4
#         with:
#           token: ${{ secrets.TOKEN }}

#       - name: Normalize image name
#         id: image
#         run: |
#           echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

#       - run: |
#           git config user.name "github-actions"
#           git config user.email "actions@github.com"

#       - name: Update deployment.yaml
#         run: |
#           IMAGE="ghcr.io/${{ steps.image.outputs.name }}:${{ needs.docker.outputs.image_tag }}"
#           sed -i "s|image:.*|image: ${IMAGE}|g" kubernetes/deployment.yaml
#           echo "Updated image to ${IMAGE}"

#       - name: Commit & push
#         run: |
#           git add kubernetes/deployment.yaml
#           git commit -m "Update image to ${{ needs.docker.outputs.image_tag }} [skip ci]" || echo "No changes"
#           git push

name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'kubernetes/deployment.yaml'

permissions:
  contents: write
  packages: write

jobs:
  docker:
    name: Build & Push Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Normalize image name
        id: image
        run: |
          echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}

      - name: Build & Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.image.outputs.name }}:sha-${{ github.sha }}
            ghcr.io/${{ steps.image.outputs.name }}:latest

      - name: Set image tag
        id: tag
        run: echo "tag=sha-${GITHUB_SHA}" >> $GITHUB_OUTPUT

  update-k8s:
    name: Update K8s Manifest (GitOps)
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN }}

      - name: Normalize image name
        id: image
        run: |
          echo "name=$(echo '${{ github.repository }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Update deployment.yaml
        run: |
          IMAGE="ghcr.io/${{ steps.image.outputs.name }}:${{ needs.docker.outputs.image_tag }}"
          sed -i.bak "s|image:.*|image: ${IMAGE}|g" kubernetes/deployment.yaml
          rm kubernetes/deployment.yaml.bak

      - name: Commit & Push
        run: |
          git add kubernetes/deployment.yaml
          git commit -m "Update image to ${{ needs.docker.outputs.image_tag }} [skip ci]" || echo "No changes"
          git push
